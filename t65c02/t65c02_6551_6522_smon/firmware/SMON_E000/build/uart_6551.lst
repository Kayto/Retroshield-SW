ca65 V2.19 - Git 62da869e4
Main file   : uart_6551.s
Current file: uart_6551.s

000000r 1               ; ----------------- assembly instructions ----------------------------
000000r 1               ;
000000r 1               ; this is a subroutine library only
000000r 1               ; it must be included in an executable source file
000000r 1               ;
000000r 1               ; Modified: 2025-11-30 by kayto@github.com for AT65C02
000000r 1               ; - Changed UAGET to truly non-blocking (returns 0 if no character)
000000r 1               ; - Added separate LAB_WAIT_Rx blocking routine
000000r 1               ;
000000r 1               ;*** I/O Locations *******************************
000000r 1               ; define the i/o address of the ACIA1 chip
000000r 1               ;*** 6551 CIA ************************
000000r 1               ; set the 6551 register addresses
000000r 1               
000000r 1               ACIA_RX         = $8400     ; ACIA receive data port
000000r 1               ACIA_TX         = $8400     ; ACIA transmit data port
000000r 1               ACIA_STATUS     = $8401     ; ACIA status port
000000r 1               ACIA_RESET      = $8401     ; ACIA reset port
000000r 1               ACIA_COMMAND    = $8402     ; ACIA command port
000000r 1               ACIA_CONTROL    = $8403	    ; ACIA control port
000000r 1               ;***********************************************************************
000000r 1               ; initialise 6551 ACIA
000000r 1               UAINIT:
000000r 1  8D 01 84     	STA	ACIA_RESET		    ; soft reset (value not important)
000003r 1  A9 0B        	LDA	#$0B		        ; set specific modes and functions
000005r 1               				            ; no parity, no echo, no Tx interrupt
000005r 1               				            ; no Rx interrupt, enable Tx/Rx
000005r 1  8D 02 84     	STA	ACIA_COMMAND		; save to command register
000008r 1               				            ; all the following 8-N-1 with the baud rate
000008r 1               				            ; generator selected. uncomment the line with
000008r 1               				            ; the required baud rate.
000008r 1               ;	LDA	#$1A		        ; 8-N-1, 2400 baud
000008r 1               ;	LDA	#$1C		        ; 8-N-1, 4800 baud
000008r 1               ;	LDA	#$1E		        ; 8-N-1, 9600 baud
000008r 1  A9 1F        	LDA	#$1F		        ; 8-N-1, 19200 baud
00000Ar 1  8D 03 84     	STA	ACIA_CONTROL		; set control register
00000Dr 1  60               RTS
00000Er 1               ;
00000Er 1               ;***********************************************************************
00000Er 1               ; 6551 I/O Support Routines
00000Er 1               ;
00000Er 1               ; wait for ACIA and Tx byte
00000Er 1               UAPUTW:
00000Er 1  48           	PHA			; save A
00000Fr 1               LAB_WAIT_Tx:
00000Fr 1  AD 01 84     	LDA	ACIA_STATUS		; get status byte
000012r 1  29 10        	AND	#$10		; mask transmit buffer status flag (6551 TDRE = bit 4)
000014r 1  F0 F9        	BEQ	LAB_WAIT_Tx	; loop if tx buffer full
000016r 1  68           	PLA			    ; restore A
000017r 1  8D 00 84     	STA	ACIA_TX		; save byte to ACIA data port
00001Ar 1  60               RTS
00001Br 1               ;
00001Br 1               ; non-waiting get character routine
00001Br 1               ; Returns: A = character if available, 0 if no character
00001Br 1               ;
00001Br 1               UAGET:
00001Br 1  AD 01 84     	LDA	ACIA_STATUS		; get ACIA status
00001Er 1  29 08        	AND	#$08		; mask rx buffer status flag (6551 RDRF = bit 3)
000020r 1  F0 04        	BEQ	UAGET_NONE	; return 0 if rx buffer empty
000022r 1  AD 00 84     	LDA	ACIA_RX		; get byte from ACIA data port
000025r 1  60               RTS
000026r 1               UAGET_NONE:
000026r 1  A9 00        	LDA #$00		; no character available
000028r 1  60           	RTS
000029r 1               
000029r 1               ; blocking get character routine (wait for ACIA and Rx byte)
000029r 1               LAB_WAIT_Rx:
000029r 1  AD 01 84     	LDA	ACIA_STATUS		; get ACIA status
00002Cr 1  29 08        	AND	#$08		; mask rx buffer status flag (6551 RDRF = bit 3)
00002Er 1  F0 F9        	BEQ	LAB_WAIT_Rx	; loop if rx buffer empty
000030r 1  AD 00 84     	LDA	ACIA_RX		; get byte from ACIA data port
000033r 1  60               RTS
000033r 1               
